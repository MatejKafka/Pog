<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <Version>0.6.0</Version>
    <IncludeSourceRevisionInInformationalVersion>false</IncludeSourceRevisionInInformationalVersion>

    <!-- If publishing, use a release build by default. -->
    <PublishRelease>true</PublishRelease>
    <!-- This is needed for XmlDoc2CmdletDoc to generate a PowerShell documentation file. -->
    <GenerateDocumentationFile>true</GenerateDocumentationFile>

    <LangVersion>default</LangVersion>
    <Nullable>enable</Nullable>
    <TargetFramework>netstandard2.0</TargetFramework>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <NoWarn>1701;1702;IL2121;CS1591</NoWarn>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(Configuration)' == 'Debug' ">
    <CheckForOverflowUnderflow>true</CheckForOverflowUnderflow>
    <DebugType>full</DebugType>
  </PropertyGroup>

  <PropertyGroup Condition=" '$(Configuration)' == 'Release' ">
    <Platform>AnyCPU</Platform>
    <PublishReadyToRun>false</PublishReadyToRun>
    <PublishSingleFile>false</PublishSingleFile>
    <PublishTrimmed>false</PublishTrimmed>
    <SelfContained>false</SelfContained>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\Polyfills\Polyfills.csproj"/>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="IsExternalInit" Version="1.0.2">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="JetBrains.Annotations" Version="2023.2.0"/>
    <PackageReference Include="PowerShellStandard.Library" Version="7.0.0-preview.1"/>
    <PackageReference Include="System.Text.Json" Version="6.0.6"/>
    <PackageReference Include="XmlDoc2CmdletDoc" Version="0.3.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
  </ItemGroup>

  <!-- Use ILRepack to combine all dependencies into one assembly for the release build. This simplifies
       loading and also shields us from dependency hell, which is especially problematic with PowerShell,
       because it seemingly ignores `<bindingRedirect>` (see https://stackoverflow.com/a/69403558/14427275). -->
  <Target Name="ILRepack" AfterTargets="Publish" Condition="'$(Configuration)' == 'Release'">
    <!-- Resolve publish dir before passing to ILRepack. -->
    <ConvertToAbsolutePath Paths="$(PublishDir)">
      <Output TaskParameter="AbsolutePaths" PropertyName="AbsPublishDir"/>
    </ConvertToAbsolutePath>

    <PropertyGroup>
      <MergedOutputPath>$(ProjectDir)\..\$(ProjectName).dll</MergedOutputPath>
      <MergedAssembly>$(AbsPublishDir)\_merged.dll</MergedAssembly>
      <MainAssembly>$(AbsPublishDir)\Pog.dll</MainAssembly>
    </PropertyGroup>

    <ItemGroup>
      <!-- List of assemblies to be merged. -->
      <AssemblyToMerge Include="$(AbsPublishDir)\*.dll" Exclude="$(AbsPublishDir)\System.Management.Automation.dll;$(MainAssembly);$(MergedAssembly)"/>
    </ItemGroup>

    <PropertyGroup>
      <IlRepackFlags>/ndebug /union /parallel /xmldocs</IlRepackFlags>
      <AssemblyListArg>&quot;$(MainAssembly)&quot; @(AssemblyToMerge->'&quot;%(FullPath)&quot;', ' ')</AssemblyListArg>
    </PropertyGroup>

    <Message Text="Running ILRepack..." Importance="High"/>
    <Exec Command="ILRepack.exe $(IlRepackFlags) /out:&quot;$(MergedAssembly)&quot; $(AssemblyListArg)"
          WorkingDirectory="$(AbsPublishDir)"/>

    <!-- Copy the merged DLL and the generated PowerShell help file. This is a separate step
         to get better error messages when the output .dll is in use. -->
    <Copy SourceFiles="$(MergedAssembly)" DestinationFiles="$(MergedOutputPath)"/>
    <Copy SourceFiles="$(TargetDir)$(ProjectName).dll-Help.xml" DestinationFiles="$(MergedOutputPath)-Help.xml"/>
  </Target>

</Project>
